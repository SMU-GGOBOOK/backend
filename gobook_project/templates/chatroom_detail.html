<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>êµí™˜ë…ì„œ ëª¨ì„ ìƒì„¸</title>
  <style>
    @import url('https://fonts.google.com/selection/embed');
    body {  
      background-color: #fafafa;
      margin: 0;
      padding: 0;
      border: 1px #ccc;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    #banner-close {
      position: absolute;
      top: 12px;    /* ë°°ë„ˆ íŒ¨ë”©ì— ë§ì¶° ì¡°ì ˆ */
      right: 12px;
      background: transparent;
      border: none;
      font-size: 20px;
      line-height: 1;
      cursor: pointer;
      color: #333;
    }
    #banner-close:hover {
      color: #ddd;
    }
    .banner {
      position: relative;
      background-color: #fafafa;
      color: #333;
      padding: 30px;
      border-radius: 7px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
    }
    .banner-text {
      flex: 1;
    }
    .banner h1 {
      margin: 0;
      font-size: 28px;
    }
    .profile-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .profile-upload img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ccc;
    }
    .profile-upload input[type="file"] {
      display: none;
    }
    .upload-label {
      background: #f0f0f0;
      color: #333;
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 7px;
      cursor: pointer;
    }

    .info {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 30px;
    }
    .info-row {
      background-color: #fafafa;
      padding: 15px 20px;
      border-radius: 7px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.05);

      display: flex;
      align-items: center;
      position: relative;
    }
    .info-row span {
      color: #666;
      font-size: 15px;
    }
    .info-row strong {
      color: #2D7868;
    }

    .info-row .tags {
      margin-left: auto;       
      display: flex;
      flex-wrap: wrap;
      gap: 5px;          
    }
    .info-row .tags strong1 {
      background-color: #2f81ed1c;
      font-size: 14px;
      font-weight: 400;
      color: #2F80ED;
      padding: 5px 10px;
      border-radius: 7px;
      display: inline-flex;
      align-items: center;
      cursor: pointer;
    }

    .description {
      background-color: #fafafa;
      color: #2D7868;
      padding: 20px;
      border-radius: 7px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.05);
      line-height: 1.6;
      font-size: 16px;
      margin-bottom: 30px;
    }
    .join-btn {
      background-color: gray;
      color: #fafafa;
      padding: 14px 24px;
      border: none;
      border-radius: 7px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
    }

    .info-row > strong {
      margin-left: auto;
    }
    

  </style>
</head>
<body>
  <div class="container">
    <div class="banner">
      <button id="banner-close" aria-label="ë‹«ê¸°">&times;</button>
      <div class="banner-text">
        <h1>ğŸŒ¿ ê°ì„± êµí™˜ë…ì„œ ëª¨ì„</h1>
        <p>ê°™ì´ ì½ê³ , ê°™ì´ ë‚˜ëˆ„ëŠ” ì‹œê°„</p>
      </div>
      <div class="profile-upload">
        <img id="profile-preview" src="https://via.placeholder.com/60/2D7868/ffffff?text=ME" alt="Profile">
        <label class="upload-label" for="profile-image">í”„ë¡œí•„ ë³€ê²½</label>
        <input type="file" id="profile-image" accept="image/*">
      </div>
    </div>

    <div class="info">
      <div class="info-row">
        <span>ğŸ“… ì±„íŒ…ë°© ìƒì„± ì¼ì‹œ</span>
        <strong>2025ë…„ 6ì›” 21ì¼ (í† )</strong>
      </div>
      <div class="info-row">
        <span>ğŸ¢ ê¼¬ë¶íƒœê·¸</span>
        <div class="tags">
          <strong1>#ì¢‹ì•„ìš”</strong1>
          <strong1>#ì¬ë°Œì–´ìš”</strong1>
          <strong1>#ê¼¬ë¶ê¼¬ë¶</strong1>
          <strong1>#ì¦ê±°ìš´</strong1>
          <strong1>#ë…ì„œ</strong1>
        </div>
      </div>
      <div class="info-row">
        <span>ğŸ“– ì±… ì œëª©</span>
        <strong>ã€ë³´í†µì˜ ì–¸ì–´ë“¤ã€ - ê¹€ì´ë‚˜</strong>
      </div>
      <div class="info-row">
        <span>ğŸ‘¥ ì¸ì›</span>
        <strong>6ëª… ì°¸ì—¬ì¤‘ / ìµœëŒ€ 10ëª…</strong>
      </div>
    </div>

    <div class="description">
      ì•ˆë…•í•˜ì„¸ìš”!<br><br>
      ì´ë²ˆ êµí™˜ë…ì„œ ëª¨ì„ì€ ê¹€ì´ë‚˜ ì‘ê°€ì˜ ã€ë³´í†µì˜ ì–¸ì–´ë“¤ã€ì„ í•¨ê»˜ ì½ê³ , ì„œë¡œì˜ ì–¸ì–´ì™€ ê°ì •ì„ ë‚˜ëˆ„ëŠ” ì‹œê°„ìœ¼ë¡œ ì¤€ë¹„í–ˆìŠµë‹ˆë‹¤. ì±… ì†ì—ì„œ ë°œê²¬í•œ êµ¬ì ˆì„ í•¨ê»˜ ë‚˜ëˆ„ê³ , ì„œë¡œ ë‹¤ë¥¸ í•´ì„ê³¼ ê°ìƒì„ ë‚˜ëˆ ë³´ëŠ” ë”°ëœ»í•œ ìë¦¬ê°€ ë˜ì—ˆìœ¼ë©´ í•©ë‹ˆë‹¤.<br><br>
      ì²˜ìŒ ì°¸ì—¬í•˜ì‹œëŠ” ë¶„ë„ ë¶€ë‹´ ì—†ì´ í•¨ê»˜í•˜ì‹¤ ìˆ˜ ìˆë„ë¡ í¸ì•ˆí•œ ë¶„ìœ„ê¸°ë¡œ ì¤€ë¹„í–ˆì–´ìš”. ğŸµ
    </div>

    <button class="join-btn"> ğŸ’¬ê·¸ë£¹ë°© ì°¸ì—¬í•˜ê¸° </button>
  </div>

<script>
    const profileInput = document.getElementById('profile-image');
    const profilePreview = document.getElementById('profile-preview');
    const joinButton = document.querySelector('.join-btn');
    const bannerCloseButton = document.getElementById('banner-close');

    // Django ì„œë²„ì˜ ì£¼ì†Œ. ê°œë°œ í™˜ê²½ì—ì„œëŠ” ì£¼ë¡œ 127.0.0.1:8000 ì…ë‹ˆë‹¤.
    const API_BASE_URL = 'http://127.0.0.1:8000/api';
    const CHAT_ROOM_ID = 1; // ì˜ˆì‹œ: ì‹¤ì œë¡œëŠ” URL íŒŒë¼ë¯¸í„° ë“±ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨

    // ì±—ë£¸ ìƒì„¸ ì •ë³´ ë¡œë“œ í•¨ìˆ˜
    async function loadChatroomDetails() {
        try {
            const response = await fetch(`${API_BASE_URL}/chatroom/${CHAT_ROOM_ID}/`);
            if (!response.ok) {
                throw new Error('Failed to fetch chatroom details');
            }
            const data = await response.json();

            document.querySelector('.banner h1').textContent = `ğŸŒ¿ ${data.name}`; //
            // description_shortê°€ ì—†ìœ¼ë¯€ë¡œ descriptionì˜ ì¼ë¶€ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ê¸°ë³¸ê°’
            document.querySelector('.banner p').textContent = data.description.split('.')[0] || 'ê°™ì´ ì½ê³ , ê°™ì´ ë‚˜ëˆ„ëŠ” ì‹œê°„';
            
            // ë‚ ì§œ í¬ë§· (YYYY-MM-DD í˜•íƒœì¼ ê²½ìš°)
            const date = new Date(data.created_at);
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' };
            document.querySelector('.info-row:nth-child(1) strong').textContent = date.toLocaleDateString('ko-KR', options); //
            
            const tagsContainer = document.querySelector('.info-row .tags');
            tagsContainer.innerHTML = ''; // ê¸°ì¡´ íƒœê·¸ ì‚­ì œ
            if (data.tags && Array.isArray(data.tags)) { // tagsê°€ ë°°ì—´ì¸ì§€ í™•ì¸
                data.tags.forEach(tag => {
                    const strong1 = document.createElement('strong1');
                    strong1.textContent = `#${tag.trim()}`;
                    tagsContainer.appendChild(strong1);
                });
            }

            document.querySelector('.info-row:nth-child(3) strong').textContent = `ã€${data.book_title}ã€ - ${data.book_author || 'ì‘ê°€ ë¯¸ìƒ'}`; //
            document.querySelector('.info-row:nth-child(4) strong').textContent = `${data.current_members}ëª… ì°¸ì—¬ì¤‘ / ìµœëŒ€ ${data.max_members}ëª…`; //
            document.querySelector('.description').innerHTML = data.description; //
            
            if (data.profile_image_url) {
                profilePreview.src = `${API_BASE_URL.replace('/api', '')}${data.profile_image_url}`; // /media/ ê²½ë¡œ
            }

        } catch (error) {
            console.error('Error loading chatroom details:', error);
            // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ ë˜ëŠ” ê¸°ë³¸ê°’ ìœ ì§€
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì±—ë£¸ ì •ë³´ ë¡œë“œ
    document.addEventListener('DOMContentLoaded', loadChatroomDetails);

    // í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ
    profileInput.addEventListener('change', async function () {
        const file = this.files[0];
        if (file && file.type.startsWith('image/')) {
            const formData = new FormData();
            formData.append('profile_image', file);
            // formData.append('user_id', '1'); // ì‹¤ì œ ì‚¬ìš©ì ID ë˜ëŠ” ì¸ì¦ í† í°ì„ ì‚¬ìš©

            try {
                const response = await fetch(`${API_BASE_URL}/profile/upload/`, {
                    method: 'POST',
                    body: formData
                    // DjangoëŠ” CSRF í† í°ì´ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë‚˜, ê°œë°œìš© CORS_ALLOW_ALL_ORIGINS=Trueì‹œ ìƒëµ ê°€ëŠ¥
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to upload profile image: ${errorData.detail || response.statusText}`);
                }

                const result = await response.json();
                profilePreview.src = `${API_BASE_URL.replace('/api', '')}${result.imageUrl}`;
                alert('í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('Error uploading profile image:', error);
                alert(`í”„ë¡œí•„ ì´ë¯¸ì§€ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }
    });

    // ê·¸ë£¹ë°© ì°¸ì—¬í•˜ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    joinButton.addEventListener('click', async function() {
        try {
            const response = await fetch(`${API_BASE_URL}/chatroom/${CHAT_ROOM_ID}/join/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_id: 1 }) // ì‹¤ì œ ì‚¬ìš©ì IDë¡œ ë³€ê²½ í•„ìš”
                // DjangoëŠ” CSRF í† í°ì´ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë‚˜, ê°œë°œìš© CORS_ALLOW_ALL_ORIGINS=Trueì‹œ ìƒëµ ê°€ëŠ¥
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Failed to join chatroom: ${errorData.detail || response.statusText}`);
            }

            const result = await response.json();
            alert(`ê·¸ë£¹ë°©ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤! í˜„ì¬ ì¸ì›: ${result.current_members}ëª…`);
            // UI ì—…ë°ì´íŠ¸ (í˜„ì¬ ì¸ì›ìˆ˜)
            document.querySelector('.info-row:nth-child(4) strong').textContent = `${result.current_members}ëª… ì°¸ì—¬ì¤‘ / ìµœëŒ€ ${result.max_members}ëª…`;
            
            // ì°¸ì—¬ í›„ ë²„íŠ¼ ë¹„í™œì„±í™” ë“± ì¶”ê°€ ì²˜ë¦¬
            joinButton.textContent = 'ì°¸ì—¬ ì™„ë£Œ';
            joinButton.disabled = true;

        } catch (error) {
            console.error('Error joining chatroom:', error);
            alert(`ê·¸ë£¹ë°© ì°¸ì—¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
    });

    // ë°°ë„ˆ ë‹«ê¸° ê¸°ëŠ¥
    bannerCloseButton.addEventListener('click', function() {
        const banner = document.querySelector('.banner');
        if (banner) {
            banner.style.display = 'none';
        }
    });

</script>
</body>
</html>
