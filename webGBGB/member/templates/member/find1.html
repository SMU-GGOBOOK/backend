{% extends "member/sample.html" %}
{% load static %}
{% block link %}
<link rel="stylesheet" type="text/css" href="{% static 'css/find.css'%}">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}
{% block title %}아이디 찾기{% endblock %}
{% block js-block %}
<script>
$(document).ready(function() {
    let isEmailSent = false;
    let isVerified = false;
    
    // 이메일 전송 버튼 클릭
    $('#sendEmailBtn').click(function(e) {
        e.preventDefault();
        
        const name = $('#nameInput').val().trim();
        const email = $('#emailInput').val().trim();

        if (!name) {
            alert('이름을 입력해주세요.');
            return;
        }

        if (!email) {
            alert('이메일을 입력해주세요.');
            return;
        }
        
        // 이메일 형식 간단 체크
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert('올바른 이메일 형식을 입력해주세요.');
            return;
        }
        
        // 버튼 비활성화
        $(this).prop('disabled', true).text('전송중...');
        
        $.ajax({
            url: '/member/send-verification/',
            type: 'POST',
            data: {
                'name': name,
                'email': email,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    isEmailSent = true;
                    $('#sendEmailBtn').text('재전송').prop('disabled', false);
                } else {
                    alert(response.message);
                    $('#sendEmailBtn').text('전송').prop('disabled', false);
                }
            },
            error: function() {
                alert('서버 오류가 발생했습니다.');
                $('#sendEmailBtn').text('전송').prop('disabled', false);
            }
        });
    });
    
    // 인증번호 확인 버튼 클릭
    $('#verifyBtn').click(function(e) {
        e.preventDefault();
        
        const verificationCode = $('#verificationInput').val().trim();
        if (!verificationCode) {
            alert('인증번호를 입력해주세요.');
            return;
        }
        
        // 버튼 비활성화
        $(this).prop('disabled', true).text('인증중...');
        
        $.ajax({
            url: '/member/verify-code/',
            type: 'POST',
            data: {
                'verification_code': verificationCode,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    isVerified = true;
                    $('#verifyBtn').text('인증완료').prop('disabled', true);
                    $('#foundIdSection').show();
                    $('#foundId').text(response.user_id);
                } else {
                    alert(response.message);
                    $('#verifyBtn').text('인증').prop('disabled', false);
                }
            },
            error: function() {
                alert('서버 오류가 발생했습니다.');
                $('#verifyBtn').text('인증').prop('disabled', false);
            }
        });
    });
});
</script>
{% endblock %}
{% block style-block %}{% endblock %}
{% block content %}
<div class="feed__content">
    <div class="feed__add">
        <div class="feed__add_title">
            <span>아이디 찾기</span>
        </div>
        <form method="post" name="findFrm">
            {% csrf_token %}
            <div class="qrqr">
                <div class="login-box">
                    <!-- 1. 이름/이메일 입력 + 전송 버튼 -->
                    <div class="inname">
                        <p>이름</p>
                        <input type="name" id="nameInput" class="idpw" placeholder="이름 입력" required>
                        <p>이메일</p>
                        <div class="qeqe">
                          <input type="email" id="emailInput" class="idpw" placeholder="이메일 입력" required>
                          <button type="button" id="sendEmailBtn" class="login-btn">전송</button>
                        </div>
                      </div>

                    
                    <!-- 2. 인증코드 입력 + 인증 버튼 -->
                    <div class="innum" id="verificationSection">
                        <p>인증번호</p>
                        <input type="text" id="verificationInput" class="idpw" placeholder="인증번호 입력" maxlength="10">
                        <button type="button" id="verifyBtn" class="login-btn">인증</button>
                    </div><br><br>
                    
                    
                    
                    <!-- 3. 아이디 표시 영역 -->
                    <div class="fid" id="foundIdSection">
                        <p> 아이디 : <strong id="foundId"></strong> </p>
                    </div>

                    <!-- 4. 로그인 버튼 -->
                    <br>
                    <br>
                    <div id="qwqw">
                        <a href="/member/find2/"><button type="button" id="fffff" class="login-btn">비밀번호 찾기</button></a>
                        <a href="/member/login/"><button type="button" id="ffff" class="login-btn">로그인</button></a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}
{% block last %}
{% endblock %}