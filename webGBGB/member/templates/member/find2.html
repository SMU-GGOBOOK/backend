{% extends "base.html" %}
{% load static %}
{% block title %}비밀번호 찾기{% endblock %}
{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/find2.css'%}">
<link rel="stylesheet" type="text/css" href="{% static 'css/Share_AddGroup.css'%}">
{% endblock %}
{% block content %}
<div class="feed__content">
    <div class="feed__add">
        <div class="feed__add_title">
            <span>비밀번호 찾기</span>
        </div><br><br>
        <form method="post" name="findFrm">
            {% csrf_token %}
            <div class="qrqr">
                <div class="login-box">
                    <!-- 1. 아이디 입력 -->
                    <div class="inid">
                      <p>아이디</p>
                        <input type="text" id="userIdInput" class="idpw" placeholder="아이디 입력" required>
                    </div><br>

                    <div class="inname">
                      <p>이름</p>
                        <input type="text" id="nameInput" class="idpw" placeholder="이름 입력" required>
                    </div><br>
                    
                    <!-- 2. 이메일 입력 + 전송 버튼 -->
                    <div class="inmail">
                      <p>이메일</p>
                        <input type="email" id="emailInput" class="idpw" placeholder="이메일 입력" required>
                        <button type="button" id="sendEmailBtn" class="login-btn">전송</button>
                    </div><br>
                    
                    <!-- 3. 인증코드 입력 + 인증 버튼 -->
                    <div class="innum">
                      <p>인증번호</p>
                        <input type="text" id="verificationInput" class="idpw" placeholder="인증번호 입력" maxlength="10">
                        <button type="button" id="verifyBtn" class="login-btn">인증</button>
                    </div><br><br>
                    
                    
                    
                    <!-- 4. 비밀번호 재설정 완료 메시지 -->
                    <div class="fid" id="passwordResetSection">
                        <p><strong>임시 비밀번호를 이메일로 발송했습니다.</strong></p>
                    </div>

                    <!-- 5. 안내 메시지 + 로그인 버튼 -->
                    <br>
                    <div class="help">
                        <p>로그인 하신 후 비밀번호를 변경해주세요.</p>
                    </div><br>
                    <div class="forbtn">
                        <a href="/member/login/"><button type="button" class="login-btn">로그인</button></a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let isEmailSent = false;
    let isVerified = false;
    
    // 이메일 전송 버튼 클릭
    $('#sendEmailBtn').click(function(e) {
        e.preventDefault();
        
        const userId = $('#userIdInput').val().trim();
        const email = $('#emailInput').val().trim();
        const name = $('#nameInput').val().trim();
        
        
        if (!userId) {
            alert('아이디를 입력해주세요.');
            return;
        }
        
        if (!name) {
            alert('이름을 입력해주세요.');
            return;
        }
        
        if (!email) {
            alert('이메일을 입력해주세요.');
            return;
        }
        
        // 이메일 형식 간단 체크
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert('올바른 이메일 형식을 입력해주세요.');
            return;
        }
        
        // 버튼 비활성화
        $(this).prop('disabled', true).text('전송중...');
        
        $.ajax({
            url: '/member/send-password-reset-code/',
            type: 'POST',
            data: {
                'user_id': userId,
                'name': name,
                'email': email,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    isEmailSent = true;
                    $('#sendEmailBtn').text('재전송').prop('disabled', false);
                } else {
                    alert(response.message);
                    $('#sendEmailBtn').text('전송').prop('disabled', false);
                }
            },
            error: function() {
                alert('서버 오류가 발생했습니다.');
                $('#sendEmailBtn').text('전송').prop('disabled', false);
            }
        });
    });
    
    // 인증번호 확인 버튼 클릭
    $('#verifyBtn').click(function(e) {
        e.preventDefault();
        
        const verificationCode = $('#verificationInput').val().trim();
        if (!verificationCode) {
            alert('인증번호를 입력해주세요.');
            return;
        }
        
        // 버튼 비활성화
        $(this).prop('disabled', true).text('인증중...');
        
        $.ajax({
            url: '/member/verify-password-reset-code/',
            type: 'POST',
            data: {
                'verification_code': verificationCode,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    isVerified = true;
                    $('#verifyBtn').text('인증완료').prop('disabled', true);
                    $('#passwordResetSection').show();
                } else {
                    alert(response.message);
                    $('#verifyBtn').text('인증').prop('disabled', false);
                }
            },
            error: function() {
                alert('서버 오류가 발생했습니다.');
                $('#verifyBtn').text('인증').prop('disabled', false);
            }
        });
    });
});
</script>
{% endblock %}